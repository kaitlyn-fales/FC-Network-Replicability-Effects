---
title: "Heatmap by Model"
author: "Xurui Zhi"
date: "2024-04-12"
output: html_document
---


# Prepare
```{r}
library(reshape2)
library(ggplot2)

# Define the base directory
base_dir <- "/Users/xuruizhi/Library/CloudStorage/OneDrive-ThePennsylvaniaStateUniversity/Scanner Heterogeneity Project/Correlation_Matrices/Matrices with center"
file_list <- list.files(path = base_dir, pattern = "\\.RData$", full.names = TRUE, ignore.case = TRUE)

# Define edges
edges <- c("MPFC:LP_L", "MPFC:LP_R", "LP_L:LP_R", "MPFC:PCC", "LP_L:PCC", "LP_R:PCC")

# The indices of the edges:
edge_indices <- list(
  "MPFC:LP_L" = c(1, 2),
  "MPFC:LP_R" = c(1, 3),
  "LP_L:LP_R" = c(2, 3),
  "MPFC:PCC" = c(1, 4),
  "LP_L:PCC" = c(2, 4),
  "LP_R:PCC" = c(3, 4)
)
```


# Data
```{r}
# Define groups of centers to combine for scanner brands
combined_centers <- list(
  SIEMENS_MAGNETOM.ALLEGRA.SYNGO.MR.2004A = c("NYU", "Olin"), 
  SIEMENS_MAGNETOM.ALLEGRA.SYNGO.MR.A30 = c("Pitt"), 
  SIEMENS_MAGNETOM.TRIOTIM.SYNGO.MR.B15 = c("UCLA_1", "UCLA_2"), 
  SIEMENS_MAGNETOM.TRIOTIM.SYNGO.MR.B17 = c("Caltech", "OHSU", "USM", "Yale"), 
  SIEMENS_MAGNETOM.VERIO.SYNGO.MR.B17 = c("CMU_a", "CMU_b", "MaxMun_a", "MaxMun_c", "MaxMun_d"), 
  PHILIPS_ACHIEVA.3T = c("KKI", "Trinity"), 
  PHILIPS_INTERA.3T = c("Leuven_1", "Leuven_2", "SBL"), 
  GE_3T.MR750 = c("SDSU"), 
  GE_SIGNA.3T = c("Stanford", "UM_1", "UM_2")
)

# Function to find the group name for a center, or return the center if not in a group
find_group_name <- function(center, combined_centers) {
  for (group_name in names(combined_centers)) {
    if (center %in% combined_centers[[group_name]]) {
      return(group_name)
    }
  }
  return(center)
}

# List to store the combined data for each center or group
center_data <- list()

# Process each .RData file
for (file_path in file_list) {
  loaded_data <- load(file_path)
  data_variable_name <- loaded_data[1]
  data_variable <- get(data_variable_name)
  
  combination <- gsub("\\..*", "", basename(file_path))

  for (item in data_variable) {
    matrix <- item[["matrix"]]
    # Use find_group_name to determine if this center is part of a combined group
    center <- find_group_name(item[["center"]], combined_centers)

    # If this is a new center or group, initialize a new matrix to hold the data
    if (!center %in% names(center_data)) {
      center_data[[center]] <- matrix(0, nrow = length(file_list), ncol = length(edges))
      rownames(center_data[[center]]) <- gsub("\\..*", "", basename(file_list))
      colnames(center_data[[center]]) <- names(edge_indices)
    }

    # Add Fisher Z-transformed values to the center's or group's data
    for (edge_name in names(edge_indices)) {
      indices <- edge_indices[[edge_name]]
      r <- matrix[indices[1], indices[2]]
      center_data[[center]][combination, edge_name] <- mean(atanh(r))
    }
  }
}
```


# Graph
```{r}
# Create and save a heatmap for each center
for (center in names(center_data)) {
  # Melt the data for plotting
  melted_data <- melt(center_data[[center]], varnames = c("Combination", "Edge"), value.name = "FisherZ")

  # Generate the heatmap
  p <- ggplot(melted_data, aes(x = Edge, y = Combination, fill = FisherZ)) +
    geom_tile() +
    scale_fill_gradient2(high = "red", midpoint = 0, name = "Fisher's Mean Z-transform", limit = c(-1, 2)) +
    labs(title = paste("Heatmap for Center:", center), x = "Edge", y = "Combination")

  # Save the heatmap
  ggsave(filename = paste0("model_heatmap_", gsub("[[:punct:]]", "", center), ".png"), plot = p, width = 10, height = 8)
}
```

